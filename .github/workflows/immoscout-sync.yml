name: ImmoScout Sync (2-min)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

concurrency:
  group: immoscout-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Call sync endpoint
        env:
          PROD_URL: ${{ secrets.PROD_URL }}
          SECRET: ${{ secrets.IMMOSCOUT_SYNC_SECRET }}
        run: |
          set -euo pipefail

          BASE="${PROD_URL%/}"
          URL="${BASE}/api/pipeline/immoscout/sync"

          echo "Calling: $URL"

          for i in 1 2 3; do
            rm -f headers.txt resp.json || true

            code=$(curl -sS -L --max-redirs 5 \
              -D headers.txt \
              -o resp.json \
              -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${SECRET}" \
              -H "Content-Type: application/json" \
              "$URL" || true)

            echo "HTTP $code"
            echo "---- headers ----"
            cat headers.txt || true
            echo "---- body ----"
            cat resp.json || true
            echo ""

            if [[ "$code" =~ ^2 ]]; then
              exit 0
            fi

            echo "Retry $i/3 in 10s..."
            sleep 10
          done

          echo "Sync failed after retries"
          exit 1
