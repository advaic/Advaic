name: ImmoScout Sync (2-min)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

concurrency:
  group: immoscout-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Call sync endpoint
        env:
          PROD_URL: ${{ secrets.PROD_URL }}
          SECRET: ${{ secrets.IMMOSCOUT_SYNC_SECRET }}
        run: |
          set -euo pipefail

          # PROD_URL should be the canonical host (avoid 307 redirects), e.g. https://www.advaic.com
          PROD_URL_CLEAN="${PROD_URL%/}"
          URL="${PROD_URL_CLEAN}/api/pipeline/immoscout/sync"

          echo "Calling: $URL"

          # 3 retries with short backoff
          for i in 1 2 3; do
            code=$(curl -sS -o resp.json -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${SECRET}" \
              -H "Content-Type: application/json" \
              "$URL" || true)

            echo "HTTP $code"
            cat resp.json || true
            echo ""

            if [ "$code" -ge "200" ] && [ "$code" -lt "300" ]; then
              exit 0
            fi

            echo "Retry $i/3 in 10s..."
            sleep 10
          done

          echo "Sync failed after retries"
          exit 1